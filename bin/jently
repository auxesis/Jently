#!/usr/bin/env ruby

# add lib directory to LOAD_PATH
require 'pathname'
lib = Pathname.new(__FILE__).parent.parent.join('lib').to_s
$: << lib

require 'optparse'
require 'ostruct'
require 'jently/core'
require 'jently/github'
require 'jently/jenkins'
require 'jently/helpers/logger'
require 'jently/helpers/repository'
require 'jently/helpers/config_file'
require 'jently/helpers/pull_requests_data'

class JentlyOptions
  def self.parse(args)
    options = OpenStruct.new
    opts = OptionParser.new do |opts|
      opts.on('-c', '--config FILE', 'Location of config file') do |file|
        options.config_filename = Pathname.new(file)
      end
      opts.on_tail('-h', '--help', 'Show this message') do
        puts opts
        exit
      end
    end

    opts.parse!(args)

    options.config_filename ||= Pathname.new(Dir.pwd).join('config.yaml')

    if not options.config_filename.exist?
      puts "The config file #{options.config_filename} doesn't exist."
      puts "Exiting."
      exit 2
    end

    begin
      ConfigFile.read(options.config_filename)
    rescue NameError => e
      puts e.message
      puts "Exiting."
      exit 2
    end

    options
  end
end

Jently = JentlyOptions.parse(ARGV)

loop do
  begin
    Log.log("Reading config from #{Jently.config_filename}")
    config = ConfigFile.read(Jently.config_filename)

    Core.poll_pull_requests_and_queue_next_job

    interval = config[:github_polling_interval_seconds]
    Log.log("Sleeping for #{interval}")
    sleep interval
  rescue => e
    Log.log('Error in main loop', e)
  end
end
